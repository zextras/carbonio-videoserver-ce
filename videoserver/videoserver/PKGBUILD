pkgname="carbonio-videoserver-ce"
pkgver="1.1.5"
pkgrel="1"
pkgdesc="An open source, general purpose, WebRTC server"
arch=('x86_64')
maintainer="Zextras <packages@zextras.com>"
url="https://zextras.com"
depends__apt=(
  "carbonio-curl"
  "carbonio-ffmpeg"
  "carbonio-libnice"
  "carbonio-libopus"
  "carbonio-librabbitmq-c"
  "carbonio-libsrtp"
  "carbonio-libusrsctp"
  "carbonio-libwebsockets"
  "carbonio-openssl"
  "carbonio-videoserver-confs-ce"
  "cdebconf"
  "debconf"
  "dialog"
  "libc6"
  "libconfig9"
  "libglib2.0-0"
  "libjansson4"
  "libmicrohttpd12"
  "libogg0"
  "libterm-readline-gnu-perl"
  "pending-setups"
  "service-discover"
  "zlib1g"
)
depends__yum=(
  "carbonio-curl"
  "carbonio-ffmpeg"
  "carbonio-libnice"
  "carbonio-libopus"
  "carbonio-librabbitmq-c"
  "carbonio-libsrtp"
  "carbonio-libusrsctp"
  "carbonio-libwebsockets"
  "carbonio-openssl"
  "carbonio-videoserver-confs-ce"
  "jansson"
  "libconfig"
  "libmicrohttpd"
  "libogg"
  "pending-setups"
  "service-discover"
  "zlib"
)
makedepends__apt=(
  "carbonio-curl"
  "carbonio-openssl"
  "gengetopt"
  "libconfig-dev"
  "libjansson-dev"
  "libmicrohttpd-dev"
  "libogg-dev"
  "zlib1g-dev"
)
makedepends__yum=(
  "carbonio-curl"
  "carbonio-openssl"
  "gengetopt"
  "jansson-devel"
  "libconfig-devel"
  "libmicrohttpd-devel"
  "libogg-devel"
  "zlib-devel"
)
debconf_template="carbonio-videoserver.templates"
section="comm"
priority="important"
source=(
  "https://github.com/meetecho/janus-gateway/archive/refs/tags/v1.1.4.tar.gz"
  "carbonio-videoserver.templates"
  "carbonio-videoserver.service"
  "carbonio-videoserver"
  "carbonio-videoserver.hcl"
  "carbonio-videoserver-sidecar.service"
  "carbonio-videoserver-setup.sh"
  "intentions.json"
  "policies.json"
  "service-protocol.json"
)
sha256sums=('292397ee925b957fec3e946b8b40d559fcdfc80d171ab9618f10df0e1ebe800f'
  'e2a56fe078902f43229aaed675b7f2aa92dd709ff0e496aa9a86e849b9c15413'
  'f21207a682102744cd81a96d1d2faa60a856adb83aa87f8ce34ffb43e4934e6e'
  'ccac4aabd346a7797efffe9049c18152a8230157603dea92076547801b7825ed'
  'a44ddebe2c41b306f75cf9affbf4069a2ca4a97dfec652f30b9e035a5fcb5183'
  '1fe4e4f4cb2a16c3cddb7cf9d1d6172e373ba2d34b868fff81e10b022ae65c0a'
  'db88dadbaa7ebce1f3c5aa8b6af031096887f6f82c1870b358fd2ca679aa370c'
  'c30836dda6d88e8e8d2fa66b0372536a2284888aa484fafbeee70c957a29f7e6'
  'cbe699652a2569ac1c5b9d9dd983d8d3788013c346a5c247425e460398771455'
  '531fc71566b22f3d9ae5662b6cdefe21cd2bc55e73ed01e111e510a6f4d37d6e')

build() {
  cd "${srcdir}/janus-gateway-1.1.4"
  export CFLAGS="-I/opt/zextras/common/include"
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib \
    -L/opt/zextras/common/lib \
    -L/usr/lib/x86_64-linux-gnu \
    -L/usr/lib"
  export PKG_CONFIG_PATH="/opt/zextras/common/lib/pkgconfig"

  ./autogen.sh
  ./configure \
    --disable-all-handlers \
    --disable-all-plugins \
    --disable-all-transports \
    --disable-docs \
    --disable-json-logger \
    --disable-turn-rest-api \
    --enable-plugin-audiobridge \
    --enable-plugin-videoroom \
    --enable-post-processing \
    --enable-rabbitmq \
    --enable-rabbitmq-event-handler \
    --enable-rest \
    --enable-websockets \
    --enable-websockets-event-handler \
    --prefix=/opt/zextras/common \
    --sysconfdir /etc
  make -j8
}

package() {
  cd "${srcdir}/janus-gateway-1.1.4"
  make DESTDIR="${pkgdir}" install configs

  cd "${srcdir}"
  install -Dm 755 carbonio-videoserver \
    "${pkgdir}/usr/bin/carbonio-videoserver"
  install -Dm 755 carbonio-videoserver.service \
    "${pkgdir}/usr/lib/systemd/system/carbonio-videoserver.service"
  install -Dm 644 carbonio-videoserver-sidecar.service \
    "${pkgdir}/lib/systemd/system/carbonio-videoserver-sidecar.service"
  install -Dm 644 carbonio-videoserver.hcl \
    "${pkgdir}/etc/zextras/service-discover/carbonio-videoserver.hcl"
  install -Dm 644 carbonio-videoserver-setup.sh \
    "${pkgdir}/etc/zextras/pending-setups.d/carbonio-videoserver.sh"
  install -Dm 644 intentions.json \
    "${pkgdir}/etc/carbonio/videoserver/service-discover/intentions.json"
  install -Dm 644 policies.json \
    "${pkgdir}/etc/carbonio/videoserver/service-discover/policies.json"
  install -Dm 644 service-protocol.json \
    "${pkgdir}/etc/carbonio/videoserver/service-discover/service-protocol.json"
  rm -rf "${pkgdir}"/etc/janus
  rm -rf "${pkgdir}"/opt/zextras/common/share/doc
  rm -rf "${pkgdir}"/opt/zextras/common/share/man
  rm -rf "${pkgdir}"/opt/zextras/common/share/janus/demos/
}

preinst__apt() {
  if [ -x "/etc/init.d/carbonio-videoserver" ]; then
    invoke-rc.d carbonio-videoserver stop || exit 1
  fi
  if [ -d /run/systemd/system ]; then
    deb-systemd-invoke stop 'carbonio-videoserver.service' >/dev/null || true
  fi
}

postinst__apt() {
  . /usr/share/debconf/confmodule

  if [ "$1" = "configure" ]; then

    # creating videoserver group if it isn't already there
    if ! getent group videoserver >/dev/null; then
      addgroup --system --force-badname --quiet videoserver
    fi

    # creating videoserver user if it isn't already there
    if ! getent passwd videoserver >/dev/null; then
      adduser --system --force-badname --quiet \
        --ingroup videoserver \
        --home /var/lib/videoserver \
        --shell /bin/false \
        videoserver
      usermod -c "videoserver WebRTC group" videoserver
    fi

    if ! test -d /var/lib/videoserver; then
      mkdir /var/lib/videoserver
      chown -R videoserver:videoserver /var/lib/videoserver
      # This directory can contain sensitive data and should not be world-readable
      chmod 0700 /var/lib/videoserver
    fi

    db_input high videoserver/public-ip || true
    db_go
    db_get videoserver/public-ip
    public_ip="$RET"
    api_secret=$(openssl rand -base64 24)
    sed -i "s#nat_1_1_mapping = \"\${PUBLIC_IP_ADDRESS}\"#nat_1_1_mapping = \"$public_ip\"#" /etc/janus/janus.jcfg
    sed -i "s#api_secret = \"\${API_SECRET}\"#api_secret = \"$api_secret\"#" /etc/janus/janus.jcfg

    if [ -d /run/systemd/system ]; then
      systemctl daemon-reload >/dev/null 2>&1 || :
      systemctl enable carbonio-videoserver.service >/dev/null 2>&1 || :
      systemctl enable carbonio-videoserver-sidecar.service >/dev/null 2>&1 || :
    fi
  fi

  echo "======================================================"
  echo "Carbonio videoserver installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

preinst__yum() {
  getent group videoserver >/dev/null || groupadd -r videoserver
  getent passwd videoserver >/dev/null ||
    useradd -r -g videoserver -d /var/lib/videoserver -s /sbin/nologin videoserver

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-videoserver.service >/dev/null 2>&1 || :
    systemctl enable carbonio-videoserver-sidecar.service >/dev/null 2>&1 || :
  fi
}

postinst__yum() {
  if [ $1 -eq 1 ]; then
    api_secret=$(openssl rand -base64 24)
    sed -i "s#api_secret = \"\${API_SECRET}\"#api_secret = \"$api_secret\"#" /etc/janus/janus.jcfg
  fi

  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
    systemctl enable carbonio-videoserver.service >/dev/null 2>&1 || :
    systemctl enable carbonio-videoserver-sidecar.service >/dev/null 2>&1 || :
  fi

  echo "======================================================"
  echo "Carbonio videoserver installed successfully!"
  echo "You must run pending-setups to configure it correctly."
  echo "======================================================"
}

prerm() {
  if [ -d /run/systemd/system ]; then
    systemctl --no-reload disable carbonio-videoserver.service >/dev/null 2>&1 || :
    systemctl --no-reload disable carbonio-videoserver-sidecar.service >/dev/null 2>&1 || :
    systemctl stop carbonio-videoserver.service >/dev/null 2>&1 || :
    systemctl stop carbonio-videoserver-sidecar.service >/dev/null 2>&1 || :
  fi
}

postrm__apt() {
  if [ "$1" = "purge" ]; then
    if getent passwd videoserver >/dev/null; then
      if which deluser >/dev/null; then
        deluser --system videoserver || echo "Could not remove videoserver user."
      fi
    fi
    if getent group videoserver >/dev/null; then
      if which delgroup >/dev/null; then
        delgroup --system videoserver || echo "Could not remove videoserver group."
      fi
    fi

    rm -f /etc/carbonio/videoserver/service-discover/token
    if [ -d /run/systemd/system ]; then
      systemctl daemon-reload >/dev/null 2>&1 || :
    fi
  fi
}

postrm__yum() {
  rm -f /etc/carbonio/videoserver/service-discover/token
  if [ -d /run/systemd/system ]; then
    systemctl daemon-reload >/dev/null 2>&1 || :
  fi
}
