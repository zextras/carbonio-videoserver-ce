targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-rabbitmq-c"
pkgver="0.11.0"
pkgrel="1"
pkgdesc="C library for rabbitmq"
pkgdesclong=(
  "C library for rabbitmq"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "carbonio-openssl"
)
makedepends:apt=(
  "cmake"
  "carbonio-openssl"
)
depends:yum=(
  "carbonio-openssl"
)
makedepends:yum=(
  "cmake"
  "carbonio-openssl"
)

section="libs"
priority="important"
sources=(
  "https://github.com/alanxz/rabbitmq-c/archive/v${pkgver}.tar.gz"
)
hashsums=(
  "skip"
)

build:ubuntu-focal() {
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib"
  export CFLAGS="-I/opt/zextras/common/include"
  export PKG_CONFIG_PATH="/opt/zextras/common/lib/pkgconfig"
  cd "${srcdir}"
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -D BUILD_EXAMPLES=OFF \
    -D BUILD_SHARED_LIBS=ON \
    -D BUILD_STATIC_LIBS=ON \
    -D BUILD_TESTING=OFF \
    -D BUILD_TOOLS=OFF \
    -D BUILD_TOOLS_DOCS=OFF \
    -D ENABLE_SSL_SUPPORT=ON \
    -D BUILD_API_DOCS=OFF \
    -D RUN_SYSTEM_TESTS=OFF \
    -Wno-dev \
    -B build \
    -S "rabbitmq-c-${pkgver}"

  make -C build
}

build:yum() {
  export LDFLAGS="-Wl,-rpath,/opt/zextras/common/lib"
  export CFLAGS="-I/opt/zextras/common/include"
  export PKG_CONFIG_PATH="/opt/zextras/common/lib/pkgconfig"
  cd "${srcdir}"
  mkdir build
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -D BUILD_EXAMPLES=OFF \
    -D BUILD_SHARED_LIBS=ON \
    -D BUILD_STATIC_LIBS=ON \
    -D BUILD_TESTING=OFF \
    -D BUILD_TOOLS=OFF \
    -D BUILD_TOOLS_DOCS=OFF \
    -D ENABLE_SSL_SUPPORT=ON \
    -D BUILD_API_DOCS=OFF \
    -D RUN_SYSTEM_TESTS=OFF \
    -Wno-dev \
    -B build \
    -S "rabbitmq-c-${pkgver}"

  make -C build
}

package:ubuntu-focal() {
  cd "${srcdir}"
  make DESTDIR="${pkgdir}" install -C build
  rm -rf "${pkgdir}"/opt/zextras/common/lib/cmake
}

package:yum() {
  cd "${srcdir}"
  make DESTDIR="${pkgdir}" install -C build
  rm -rf "${pkgdir}"/opt/zextras/common/lib/cmake
}
