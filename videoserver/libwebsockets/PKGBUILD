targets=(
  "centos"
  "ubuntu"
)
pkgname="zimbra-libwebsockets"
pkgver="4.2.0"
pkgrel="1"
pkgdesc="C library for websocket clients and servers"
pkgdesclong=(
  "C library for websocket clients and servers"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "libuv1"
  "openssl"
)
makedepends:apt=(
  "cmake"
  "libev-dev"
  "libuv1-dev"
  "libssl-dev"
)
depends:yum=(
  "libev"
  "libuv"
  "openssl"
)
makedepends:yum=(
  "cmake"
  "libev-devel"
  "libuv-devel"
  "openssl-devel"
  "zlib-devel"
)

section="libs"
priority="important"
sources=(
  "https://github.com/warmcat/libwebsockets/archive/v${pkgver}.tar.gz"
)
hashsums=(
  "e1fb5b204a030ded8dfe2a75c66ec8d1a2e6a67e82c7709fe3c4277e0ccb5fb40c18db04e73c640d07ef4516aa266ae8b102f802b2a41b80980260cb6921f369"
)

build:apt() {
  cd "${srcdir}/libwebsockets-${pkgver}"
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zimbra/common \
    -D CMAKE_C_FLAGS="-fno-strict-aliasing -O2 -g" \
    -D CMAKE_SHARED_LINKER_FLAGS="-Wl,-rpath,/opt/zimbra/common/lib" \
    -D LWS_BUILD_HASH="no_hash" \
    -D LWS_IPV6=OFF \
    -D LWS_LINK_TESTAPPS_DYNAMIC=ON \
    -D LWS_WITH_ACME=ON \
    -D LWS_WITH_DISKCACHE=ON \
    -D LWS_WITH_EXTERNAL_POLL=OFF \
    -D LWS_WITH_FTS=ON \
    -D LWS_WITH_GLIB=ON \
    -D LWS_WITH_HTTP2=ON \
    -D LWS_WITH_HTTP_PROXY=ON \
    -D LWS_WITH_LIBEV=ON \
    -D LWS_WITH_LIBEVENT=OFF \
    -D LWS_WITH_LIBUV=ON \
    -D LWS_WITH_LWSAC=ON \
    -D LWS_WITH_RANGES=ON \
    -D LWS_WITH_SOCKS5=ON \
    -D LWS_WITH_STATIC=OFF \
    -D LWS_WITH_THREADPOOL=ON \
    -D LWS_WITH_ZIP_FOPS=ON \
    -D LWS_WITHOUT_BUILTIN_GETIFADDRS=ON \
    -D LWS_WITHOUT_BUILTIN_SHA1=ON \
    -D LWS_WITHOUT_CLIENT=OFF \
    -D LWS_WITHOUT_SERVER=OFF \
    -D LWS_WITHOUT_TESTAPPS=ON \
    -D LWS_WITHOUT_TEST_CLIENT=ON \
    -D LWS_WITHOUT_TEST_PING=ON \
    -D LWS_WITHOUT_TEST_SERVER=OFF \
    -D LWS_WITHOUT_TEST_SERVER_EXTPOLL=ON \
    -D LWS_UNIX_SOCK=ON \
    -Wno-dev \
    -B build \
    -S .
  make
}

build:yum() {
  cd "${srcdir}/libwebsockets-${pkgver}"
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zimbra/common \
    -D CMAKE_C_FLAGS="-fno-strict-aliasing -O2 -g" \
    -D CMAKE_SHARED_LINKER_FLAGS="-Wl,-rpath,/opt/zimbra/common/lib" \
    -D LWS_BUILD_HASH="no_hash" \
    -D LWS_IPV6=OFF \
    -D LWS_LINK_TESTAPPS_DYNAMIC=ON \
    -D LWS_WITH_ACME=ON \
    -D LWS_WITH_DISKCACHE=ON \
    -D LWS_WITH_EXTERNAL_POLL=OFF \
    -D LWS_WITH_FTS=ON \
    -D LWS_WITH_GLIB=ON \
    -D LWS_WITH_HTTP2=ON \
    -D LWS_WITH_HTTP_PROXY=ON \
    -D LWS_WITH_LIBEV=ON \
    -D LWS_WITH_LIBEVENT=OFF \
    -D LWS_WITH_LIBUV=ON \
    -D LWS_WITH_LWSAC=ON \
    -D LWS_WITH_RANGES=ON \
    -D LWS_WITH_SOCKS5=ON \
    -D LWS_WITH_STATIC=OFF \
    -D LWS_WITH_THREADPOOL=ON \
    -D LWS_WITH_ZIP_FOPS=ON \
    -D LWS_WITHOUT_BUILTIN_GETIFADDRS=ON \
    -D LWS_WITHOUT_BUILTIN_SHA1=ON \
    -D LWS_WITHOUT_CLIENT=OFF \
    -D LWS_WITHOUT_SERVER=OFF \
    -D LWS_WITHOUT_TESTAPPS=ON \
    -D LWS_WITHOUT_TEST_CLIENT=ON \
    -D LWS_WITHOUT_TEST_PING=ON \
    -D LWS_WITHOUT_TEST_SERVER=OFF \
    -D LWS_WITHOUT_TEST_SERVER_EXTPOLL=ON \
    -D LWS_UNIX_SOCK=ON \
    -Wno-dev \
    -B build \
    -S .
  make -C build
}

package:apt() {
  cd "${srcdir}/libwebsockets-${pkgver}"
  make DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}"/opt/zimbra/common/lib/cmake
}

package:yum() {
  cd "${srcdir}/libwebsockets-${pkgver}"
  make -C build DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}"/opt/zimbra/common/lib/cmake
}
