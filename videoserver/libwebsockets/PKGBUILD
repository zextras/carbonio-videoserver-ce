targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-libwebsockets"
pkgver="4.3.1"
pkgrel="1"
pkgdesc="C library for websocket clients and servers"
pkgdesclong=(
  "C library for websocket clients and servers"
)
arch="amd64"
maintainer="Zextras <packages@zextras.com"
url="https://zextras.com"
depends:apt=(
  "carbonio-libev"
  "carbonio-libuv"
  "openssl"
)
makedepends:apt=(
  "cmake"
  "libssl-dev"
)
depends:yum=(
  "carbonio-libev"
  "carbonio-libuv"
  "openssl"
)
makedepends:yum=(
  "cmake"
  "openssl-devel"
  "zlib-devel"
)

section="libs"
priority="important"
sources=(
  "https://github.com/warmcat/libwebsockets/archive/v${pkgver}.tar.gz"
)
hashsums=(
  "8fdb1454a1b34cd9a6351beaab237a485e6853806101de7e62bd2bc250bb50af"
)

build:ubuntu-bionic() {
  cd "${srcdir}"
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -D CMAKE_SHARED_LINKER_FLAGS="-Wl,-rpath,/opt/zextras/common/lib" \
    -D LIBEV_INCLUDE_DIRS="/opt/zextras/common/include" \
    -D LIBEV_LIBRARIES="/opt/zextras/common/lib/libev.so" \
    -D LWS_LIBUV_INCLUDE_DIRS="/opt/zextras/common/include" \
    -D LWS_BUILD_HASH="no_hash" \
    -D LWS_IPV6=OFF \
    -D LWS_LINK_TESTAPPS_DYNAMIC=ON \
    -D LWS_WITH_ACME=ON \
    -D LWS_WITH_DISKCACHE=ON \
    -D LWS_WITH_EXTERNAL_POLL=OFF \
    -D LWS_WITH_FTS=ON \
    -D LWS_WITH_GLIB=ON \
    -D LWS_WITH_HTTP2=ON \
    -D LWS_WITH_HTTP_PROXY=ON \
    -D LWS_WITH_LIBEV=ON \
    -D LWS_WITH_LIBEVENT=OFF \
    -D LWS_WITH_LIBUV=ON \
    -D LWS_WITH_LWSAC=ON \
    -D LWS_WITH_RANGES=ON \
    -D LWS_WITH_SOCKS5=ON \
    -D LWS_WITH_STATIC=OFF \
    -D LWS_WITH_THREADPOOL=ON \
    -D LWS_WITH_ZIP_FOPS=ON \
    -D LWS_WITHOUT_BUILTIN_GETIFADDRS=ON \
    -D LWS_WITHOUT_BUILTIN_SHA1=ON \
    -D LWS_WITHOUT_CLIENT=OFF \
    -D LWS_WITHOUT_SERVER=OFF \
    -D LWS_WITHOUT_TESTAPPS=ON \
    -D LWS_WITHOUT_TEST_CLIENT=ON \
    -D LWS_WITHOUT_TEST_PING=ON \
    -D LWS_WITHOUT_TEST_SERVER=OFF \
    -D LWS_WITHOUT_TEST_SERVER_EXTPOLL=ON \
    -D LWS_UNIX_SOCK=ON \
    -Wno-dev \
    -B build \
    -S "libwebsockets-${pkgver}"

  make VERBOSE=1
}

build:ubuntu-focal() {
  cd "${srcdir}"
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -D CMAKE_SHARED_LINKER_FLAGS="-Wl,-rpath,/opt/zextras/common/lib" \
    -D LIBEV_INCLUDE_DIRS="/opt/zextras/common/include" \
    -D LIBEV_LIBRARIES="/opt/zextras/common/lib/libev.so" \
    -D LWS_LIBUV_INCLUDE_DIRS="/opt/zextras/common/include" \
    -D LWS_BUILD_HASH="no_hash" \
    -D LWS_IPV6=OFF \
    -D LWS_LINK_TESTAPPS_DYNAMIC=ON \
    -D LWS_WITH_ACME=ON \
    -D LWS_WITH_DISKCACHE=ON \
    -D LWS_WITH_EXTERNAL_POLL=OFF \
    -D LWS_WITH_FTS=ON \
    -D LWS_WITH_GLIB=ON \
    -D LWS_WITH_HTTP2=ON \
    -D LWS_WITH_HTTP_PROXY=ON \
    -D LWS_WITH_LIBEV=ON \
    -D LWS_WITH_LIBEVENT=OFF \
    -D LWS_WITH_LIBUV=ON \
    -D LWS_WITH_LWSAC=ON \
    -D LWS_WITH_RANGES=ON \
    -D LWS_WITH_SOCKS5=ON \
    -D LWS_WITH_STATIC=OFF \
    -D LWS_WITH_THREADPOOL=ON \
    -D LWS_WITH_ZIP_FOPS=ON \
    -D LWS_WITHOUT_BUILTIN_GETIFADDRS=ON \
    -D LWS_WITHOUT_BUILTIN_SHA1=ON \
    -D LWS_WITHOUT_CLIENT=OFF \
    -D LWS_WITHOUT_SERVER=OFF \
    -D LWS_WITHOUT_TESTAPPS=ON \
    -D LWS_WITHOUT_TEST_CLIENT=ON \
    -D LWS_WITHOUT_TEST_PING=ON \
    -D LWS_WITHOUT_TEST_SERVER=OFF \
    -D LWS_WITHOUT_TEST_SERVER_EXTPOLL=ON \
    -D LWS_UNIX_SOCK=ON \
    -Wno-dev \
    -B build \
    -S "libwebsockets-${pkgver}"

  make VERBOSE=1 -C build
}

build:yum() {
  cd "${srcdir}"
  mkdir build
  cmake -D CMAKE_INSTALL_PREFIX=/opt/zextras/common \
    -D CMAKE_SHARED_LINKER_FLAGS="-Wl,-rpath,/opt/zextras/common/lib" \
    -D LIBEV_INCLUDE_DIRS="/opt/zextras/common/include" \
    -D LIBEV_LIBRARIES="/opt/zextras/common/lib/libev.so" \
    -D LWS_LIBUV_INCLUDE_DIRS="/opt/zextras/common/include" \
    -D LWS_BUILD_HASH="no_hash" \
    -D LWS_IPV6=OFF \
    -D LWS_LINK_TESTAPPS_DYNAMIC=ON \
    -D LWS_WITH_ACME=ON \
    -D LWS_WITH_DISKCACHE=ON \
    -D LWS_WITH_EXTERNAL_POLL=OFF \
    -D LWS_WITH_FTS=ON \
    -D LWS_WITH_GLIB=ON \
    -D LWS_WITH_HTTP2=ON \
    -D LWS_WITH_HTTP_PROXY=ON \
    -D LWS_WITH_LIBEV=ON \
    -D LWS_WITH_LIBEVENT=OFF \
    -D LWS_WITH_LIBUV=ON \
    -D LWS_WITH_LWSAC=ON \
    -D LWS_WITH_RANGES=ON \
    -D LWS_WITH_SOCKS5=ON \
    -D LWS_WITH_STATIC=OFF \
    -D LWS_WITH_THREADPOOL=ON \
    -D LWS_WITH_ZIP_FOPS=ON \
    -D LWS_WITHOUT_BUILTIN_GETIFADDRS=ON \
    -D LWS_WITHOUT_BUILTIN_SHA1=ON \
    -D LWS_WITHOUT_CLIENT=OFF \
    -D LWS_WITHOUT_SERVER=OFF \
    -D LWS_WITHOUT_TESTAPPS=ON \
    -D LWS_WITHOUT_TEST_CLIENT=ON \
    -D LWS_WITHOUT_TEST_PING=ON \
    -D LWS_WITHOUT_TEST_SERVER=OFF \
    -D LWS_WITHOUT_TEST_SERVER_EXTPOLL=ON \
    -D LWS_UNIX_SOCK=ON \
    -Wno-dev \
    -B build \
    -S "libwebsockets-${pkgver}"

  make VERBOSE=1 -C build
}

package:ubuntu-bionic() {
  cd "${srcdir}"
  make DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}"/opt/zextras/common/lib/cmake
}

package:ubuntu-focal() {
  cd "${srcdir}"
  make DESTDIR="${pkgdir}" install -C build
  rm -rf "${pkgdir}"/opt/zextras/common/lib/cmake
}

package:yum() {
  cd "${srcdir}"
  make DESTDIR="${pkgdir}" install -C build
  rm -rf "${pkgdir}"/opt/zextras/common/lib/cmake
}
