#!/bin/sh
set -e
. /usr/share/debconf/confmodule

if [ "$1" = "configure" ]; then

  # creating videoserver group if it isn't already there
  if ! getent group videoserver >/dev/null; then
    addgroup --system --force-badname --quiet videoserver
  fi

  # creating videoserver user if it isn't already there
  if ! getent passwd videoserver >/dev/null; then
    adduser --system --force-badname --quiet \
      --ingroup videoserver \
      --home /var/lib/videoserver \
      --shell /bin/false \
      videoserver
    usermod -c "videoserver WebRTC group" videoserver
  fi

  if ! test -d /var/lib/videoserver; then
    mkdir /var/lib/videoserver
    chown -R videoserver:videoserver /var/lib/videoserver
    # This directory can contain sensitive data and should not be world-readable
    chmod 0700 /var/lib/videoserver
  fi

  db_input high videoserver/public-ip || true
  db_go
  db_get videoserver/public-ip
  public_ip="$RET"
  api_secret=$(openssl rand -base64 24)
  sed -i "s#nat_1_1_mapping = \".*\"#nat_1_1_mapping = \"$public_ip\"#" /etc/janus/janus.jcfg
  sed -i "s#api_secret = \".*\"#api_secret = \"$api_secret\"#" /etc/janus/janus.jcfg
  hostname=$(hostname -f)
  db_subst videoserver/add API_SECRET "${api_secret}"
  db_subst videoserver/add HOSTNAME "${hostname}"
  db_input high videoserver/add || true
  db_go
fi # End of configure

#DEBHELPER#

exit 0
